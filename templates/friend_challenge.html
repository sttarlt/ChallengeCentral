{% extends "layout.html" %}

{% block title %}ØªØ­Ø¯ÙŠ Ø§Ù„ØµØ¯ÙŠÙ‚{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h3 class="mb-0">ØªØ­Ø¯ÙŠ Ø§Ù„ØµØ¯ÙŠÙ‚</h3>
                </div>
                <div class="card-body p-4">
                    {% if reached_limit %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©. Ø´ÙƒØ±Ù‹Ø§ Ù„Ù…Ø³Ø§Ù‡Ù…ØªÙƒ!</strong>
                    </div>
                    {% endif %}
                    
                    <p class="lead">Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆØ§Ø±Ø¨Ø­ ÙƒØ±Ø¨ØªÙˆ Ù…Ø¹ ÙƒÙ„ Ø¯Ø¹ÙˆØ© Ù†Ø§Ø¬Ø­Ø©!</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="fw-bold">Ù…ÙƒØ§ÙØ£Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚</h5>
                                    <p class="display-5 text-primary mb-0">{{ referral_reward }}</p>
                                    <p>ÙƒØ±Ø¨ØªÙˆ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="fw-bold">Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h5>
                                    <p class="display-5 text-primary mb-0">{{ welcome_bonus }}</p>
                                    <p>ÙƒØ±Ø¨ØªÙˆ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="fw-bold">Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ©</h5>
                                    <p class="mb-1">ÙƒÙ„ 5 Ø£ØµØ¯Ù‚Ø§Ø¡: <span class="fw-bold">10</span> ÙƒØ±Ø¨ØªÙˆ</p>
                                    <p class="mb-0">ÙƒÙ„ 10 Ø£ØµØ¯Ù‚Ø§Ø¡: <span class="fw-bold">20</span> ÙƒØ±Ø¨ØªÙˆ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="card h-100 border-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h5>
                                    <div class="mb-3">
                                        <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†ØµØ± textarea Ù…Ø¹ Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆØ§Ø¶Ø­Ø© -->
                                        <div class="form-floating mb-2">
                                            <textarea class="form-control border-2" id="referralLink" 
                                                style="height: 80px; direction: ltr; text-align: left; font-family: monospace; font-size: 1.1em;" 
                                                readonly>{{ referral_url }}</textarea>
                                            <label for="referralLink">
                                                <i class="bi bi-link-45deg"></i> Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
                                            </label>
                                        </div>
                                        
                                        <!-- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙˆØ¸Ø§Ø¦Ù - Ø£Ø²Ø±Ø§Ø± Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
                                        <div class="d-flex gap-2 flex-wrap">
                                            <!-- Ø²Ø± Ù†Ø³Ø® Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ - Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ø¨ÙŠØ¦Ø© Replit -->
                                            <button id="copyButton" class="btn btn-primary flex-grow-1 position-relative" 
                                                    type="button" onclick="copyReferralLink()">
                                                <span class="d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-clipboard me-1"></i> 
                                                    <span id="copyButtonText">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</span>
                                                </span>
                                                <span id="copySpinner" class="spinner-border spinner-border-sm position-absolute" 
                                                      role="status" style="display: none; right: 10px;"></span>
                                            </button>
                                            
                                            <!-- Ø²Ø± Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠ Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
                                            <button class="btn btn-outline-primary" 
                                                   type="button" 
                                                   onclick="document.getElementById('referralLink').select();">
                                                <i class="bi bi-cursor-text"></i>
                                                <span class="d-none d-md-inline-block">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ</span>
                                            </button>

                                            <!-- Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ Ù…ÙØ­Ø³Ù† Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© - Ù…Ø­ÙˆÙ‘Ù„ Ù„Ø²Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ø§Ø¨Ø· -->
                                            <button id="whatsappShareButton" type="button"
                                               onclick="shareViaWhatsApp(event)"
                                               class="btn btn-success flex-grow-1 d-flex align-items-center justify-content-center gap-1">
                                                <i class="bi bi-whatsapp"></i>
                                                <span>Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ø¶Ø­Ø© -->
                                    <div id="copyMessage" class="alert my-2 py-2 rounded-3" style="display: none;">
                                        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h5>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center border-0">
                                            Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                                            <span class="badge bg-primary rounded-pill">{{ referred_friends_count }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center border-0">
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ±Ø¨ØªÙˆ Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©
                                            <span class="badge bg-primary rounded-pill">{{ total_referral_points }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if next_milestone_info %}
                    <div class="alert alert-success">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-gift-fill fs-2"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="alert-heading">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h5>
                                <p class="mb-0">Ø¨Ù‚ÙŠ {{ next_milestone_info.remaining }} Ø¥Ø­Ø§Ù„Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ {{ next_milestone_info.reward }} ÙƒØ±Ø¨ØªÙˆ Ø¥Ø¶Ø§ÙÙŠØ©!</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Progress bars for limits -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ±Ø¨ØªÙˆ</h5>
                            
                            <label class="form-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ ({{ monthly_used }} / {{ monthly_limit }})</label>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                    style="width: {{ (monthly_used / monthly_limit * 100)|round }}%;" 
                                    aria-valuenow="{{ monthly_used }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="{{ monthly_limit }}">
                                    {{ monthly_used }} / {{ monthly_limit }}
                                </div>
                            </div>
                            
                            <label class="form-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ({{ total_used }} / {{ total_limit }})</label>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                    style="width: {{ (total_used / total_limit * 100)|round }}%;" 
                                    aria-valuenow="{{ total_used }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="{{ total_limit }}">
                                    {{ total_used }} / {{ total_limit }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h4 class="mb-0">ÙƒÙŠÙÙŠØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h4>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="text-center">
                                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <h3 class="mb-0">1</h3>
                                </div>
                                <h5>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©</h5>
                                <p>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="text-center">
                                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <h3 class="mb-0">2</h3>
                                </div>
                                <h5>Ø´Ø§Ø±Ùƒ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</h5>
                                <p>Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ø¹Ø¨Ø± ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <h3 class="mb-0">3</h3>
                                </div>
                                <h5>Ø§Ø±Ø¨Ø­ Ø§Ù„ÙƒØ±Ø¨ØªÙˆ</h5>
                                <p>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒØ±Ø¨ØªÙˆ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø¬Ù„ Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·Ùƒ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
/**
 * ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© ØªØ­Ø¯ÙŠ Ø§Ù„ØµØ¯ÙŠÙ‚");
    setupReferralLinkField();
});

/**
 * Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª
 */
function setupReferralLinkField() {
    const referralField = document.getElementById('referralLink');
    if (!referralField) return;
    
    // 1. Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ù„Ù†Ù‚Ø± Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³
    referralField.addEventListener('click', function() {
        this.select();
    });
    
    referralField.addEventListener('touchend', function(e) {
        this.select();
        e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
    });
    
    // 2. Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ­Ø§Øª Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    referralField.title = "Ø§Ù†Ù‚Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„";
    
    // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Øµ ÙÙ‚Ø· Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆÙ„ÙƒÙ† Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£ÙØ¶Ù„
    referralField.setAttribute('readonly', 'readonly');
    referralField.spellcheck = false;
}

/**
 * ÙˆØ¸ÙŠÙØ© Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© - Ø¥ØµØ¯Ø§Ø± Ù…ÙØ¨Ø³Ø· ÙˆØ£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø®ØµÙŠØµØ§Ù‹ Ù„Ø¨ÙŠØ¦Ø© Replit
 * ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù…Ø¹ ØªØ¨Ø³ÙŠØ· Ø¢Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ù…Ù‚ÙŠØ¯Ø©
 */
function copyReferralLink() {
    console.log("âš™ï¸ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©");
    
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
    const copyButton = document.getElementById('copyButton');
    const copyButtonText = document.getElementById('copyButtonText');
    const copySpinner = document.getElementById('copySpinner');
    const referralField = document.getElementById('referralLink');
    const copyMessage = document.getElementById('copyMessage');
    
    if (!referralField || !copyButton || !copyButtonText || !copySpinner || !copyMessage) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ù†Ø³Ø®"); // Ø§Ø³ØªØ®Ø¯Ø§Ù… alert Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
        return;
    }
    
    // 2. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    copySpinner.style.display = 'inline-block';
    copyButtonText.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ø³Ø®...';
    copyButton.disabled = true;
    copyButton.style.backgroundColor = '#0d6efd'; // ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    
    // 3. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ù„Ù„Ù†Ø³Ø®
    const textToCopy = referralField.value.trim();
    if (!textToCopy) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ù†Ø³Ø®!"); // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        resetCopyButton(copyButton, copyButtonText, copySpinner);
        return;
    }
    
    // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ù†ØµÙŠ Ù…Ø¤Ù‚Øª Ù„Ù„Ù†Ø³Ø® - ØªÙ‚Ù†ÙŠØ© Ø£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© ÙÙŠ Replit
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = textToCopy;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.left = '-999999px';
    tempTextarea.style.top = '-999999px';
    document.body.appendChild(tempTextarea);
    
    // 5. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ©
    referralField.style.backgroundColor = '#e8f4ff';
    referralField.style.color = '#0d6efd';
    referralField.style.transition = 'all 0.3s';
    referralField.style.borderColor = '#0d6efd';
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    doClipboardCopy();
    
    function doClipboardCopy() {
        // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
        if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            console.log("Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API");
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    console.log("âœ… Ù†Ø¬Ø­ Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API");
                    showSuccessUI();
                })
                .catch(err => {
                    console.warn("âš ï¸ ÙØ´Ù„Øª Clipboard API:", err);
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
                    fallbackCopy();
                });
        } else {
            console.log("âš ï¸ Clipboard API ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
            fallbackCopy();
        }
    }
    
    // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
    function fallbackCopy() {
        try {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª
            tempTextarea.focus();
            tempTextarea.select();
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ù†Ø³Ø®
            const successful = document.execCommand('copy');
            
            if (successful) {
                console.log("âœ… Ù†Ø¬Ø­ Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… execCommand");
                showSuccessUI();
            } else {
                console.warn("âš ï¸ ÙØ´Ù„ execCommand");
                showManualCopyUI();
            }
        } catch (err) {
            console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®:", err);
            showManualCopyUI();
        } finally {
            // ØªÙ†Ø¸ÙŠÙ - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª
            document.body.removeChild(tempTextarea);
        }
    }
    
    // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    function showSuccessUI() {
        console.log("âœ… Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø¬Ø§Ø­");
        
        // 1. ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        copyButton.disabled = false;
        copyButton.style.backgroundColor = '#198754'; // Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø£Ø®Ø¶Ø±
        copyButton.style.borderColor = '#198754';
        copyButton.style.color = 'white';
        copySpinner.style.display = 'none';
        copyButtonText.innerHTML = '<i class="bi bi-check-lg me-1"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
        
        // 2. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ ÙˆØ§Ø¶Ø­Ø©
        if (copyMessage) {
            copyMessage.style.display = 'block';
            copyMessage.style.backgroundColor = '#d1e7dd';
            copyMessage.style.color = '#0f5132';
            copyMessage.style.border = '1px solid #badbcc';
            copyMessage.style.borderRadius = '0.375rem';
            copyMessage.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> <strong>ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</strong>';
        }
        
        // 3. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
        setTimeout(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø²Ø±
            copyButton.style.backgroundColor = '#0d6efd'; // Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø£Ø³Ø§Ø³ÙŠ
            copyButton.style.borderColor = '#0d6efd';
            copyButtonText.innerHTML = '<i class="bi bi-clipboard me-1"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
            if (copyMessage) {
                copyMessage.style.opacity = '0';
                copyMessage.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                    copyMessage.style.opacity = '1';
                }, 500);
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
            referralField.style.backgroundColor = '';
            referralField.style.color = '';
            referralField.style.borderColor = '';
        }, 2000);
    }
    
    // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
    function showManualCopyUI() {
        console.log("âš ï¸ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ");
        
        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        referralField.focus();
        referralField.select();
        
        // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±
        copyButton.disabled = false;
        copyButton.style.backgroundColor = '#0dcaf0'; // Ù„ÙˆÙ† info
        copyButton.style.borderColor = '#0dcaf0';
        copyButton.style.color = 'white';
        copySpinner.style.display = 'none';
        copyButtonText.innerHTML = '<i class="bi bi-hand-index me-1"></i> Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹';
        
        // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¬ÙŠÙ‡ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
        if (copyMessage) {
            copyMessage.style.display = 'block';
            copyMessage.style.backgroundColor = '#cff4fc';
            copyMessage.style.color = '#055160';
            copyMessage.style.border = '1px solid #b6effb';
            copyMessage.style.borderRadius = '0.375rem';
            copyMessage.style.padding = '0.75rem 1.25rem';
            copyMessage.innerHTML = '<i class="bi bi-info-circle-fill me-2"></i> <strong>Ø§Ø¶ØºØ· Ctrl+C (Ø£Ùˆ Cmd+C) Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</strong>';
        }
        
        // 4. ØªÙƒØ±Ø§Ø± Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
        let selectionInterval = setInterval(() => {
            referralField.focus();
            referralField.select();
        }, 1000);
        
        // 5. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            clearInterval(selectionInterval);
            
            // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠØ© Ø¨ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
            if (copyMessage) {
                copyMessage.innerHTML = `
                    <i class="bi bi-info-circle-fill me-2"></i> 
                    <strong>Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹:</strong>
                    <ol class="mt-2 mb-0">
                        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ" Ø£Ùˆ Ø­Ø¯Ø¯ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹</li>
                        <li>Ø§Ø¶ØºØ· Ctrl+C (ÙÙŠ ÙˆÙŠÙ†Ø¯ÙˆØ²) Ø£Ùˆ Cmd+C (ÙÙŠ Ù…Ø§Ùƒ) Ù„Ù„Ù†Ø³Ø®</li>
                    </ol>
                `;
            }
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø® Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
            document.addEventListener('copy', function onManualCopy() {
                console.log("âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø®");
                
                if (copyMessage) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªÙØ¸Ù‡Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
                    copyMessage.style.backgroundColor = '#d1e7dd';
                    copyMessage.style.color = '#0f5132';
                    copyMessage.style.border = '1px solid #badbcc';
                    copyMessage.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> <strong>ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</strong>';
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ù†Ø¬Ø§Ø­
                copyButton.style.backgroundColor = '#198754'; // Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø£Ø®Ø¶Ø±
                copyButton.style.borderColor = '#198754';
                copyButtonText.innerHTML = '<i class="bi bi-check-lg me-1"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
                setTimeout(() => {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø²Ø±
                    copyButton.style.backgroundColor = '#0d6efd'; // Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø£Ø³Ø§Ø³ÙŠ
                    copyButton.style.borderColor = '#0d6efd';
                    copyButtonText.innerHTML = '<i class="bi bi-clipboard me-1"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
                    if (copyMessage) {
                        copyMessage.style.opacity = '0';
                        copyMessage.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            copyMessage.style.display = 'none';
                            copyMessage.style.opacity = '1';
                        }, 500);
                    }
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    referralField.style.backgroundColor = '';
                    referralField.style.color = '';
                    referralField.style.borderColor = '';
                }, 2000);
                
                document.removeEventListener('copy', onManualCopy);
            }, { once: true });
        }, 5000);
    }
}

/**
 * Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
function showManualCopyInstructions(field, button, buttonText, spinner, messageElement) {
    // ØªØ£ÙƒÙŠØ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
    field.select();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¬ÙŠÙ‡ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    showMessage(messageElement, true, "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·! Ø§Ø³ØªØ®Ø¯Ù… Ctrl+C (Ø£Ùˆ Cmd+C) Ù„Ù†Ø³Ø®Ù‡");
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø²Ø± Ø§Ù„Ù†Ø³Ø®
    resetCopyButton(button, buttonText, spinner);
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø¯Ø« 'copy' Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠ Ù†Ø§Ø¬Ø­
    document.addEventListener('copy', function copyDetected() {
        showMessage(messageElement, true, "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­! ğŸ‘");
        document.removeEventListener('copy', copyDetected);
    }, { once: true });
}

/**
 * Ø¥Ø¨Ø±Ø§Ø² Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø¨ØµØ±ÙŠÙ‹Ø§ Ù„Ø¬Ø°Ø¨ Ø§Ù†ØªØ¨Ø§Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
function highlightTextField(field) {
    field.classList.add('border-primary');
    
    // Ø­ÙØ¸ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalBg = field.style.backgroundColor;
    const originalColor = field.style.color;
    const originalWeight = field.style.fontWeight;
    
    // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    field.style.backgroundColor = "#e8f4ff";
    field.style.color = "#0d6efd";
    field.style.fontWeight = "bold";
    field.style.transition = "all 0.2s ease";
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
    setTimeout(() => field.select(), 50);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
    setTimeout(() => {
        field.style.backgroundColor = originalBg;
        field.style.color = originalColor;
        field.style.fontWeight = originalWeight;
        field.classList.remove('border-primary');
    }, 4000);
}

/**
 * Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø³Ø® ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
 */
function showCopySuccess(button, buttonText, spinner, messageElement) {
    // 1. Ø¥Ø¸Ù‡Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø¨ØµØ±ÙŠ ÙÙŠ Ø§Ù„Ø²Ø±
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
    spinner.style.display = 'none';
    buttonText.innerHTML = '<i class="bi bi-check-lg me-1"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
    
    // 2. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showMessage(messageElement, true, "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­! ğŸ‘");
    
    // 3. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
    setTimeout(() => {
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
        button.disabled = false;
        buttonText.innerHTML = '<i class="bi bi-clipboard me-1"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
    }, 2000);
}

/**
 * Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
 */
function resetCopyButton(button, buttonText, spinner) {
    spinner.style.display = 'none';
    button.disabled = false;
    buttonText.innerHTML = '<i class="bi bi-clipboard me-1"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
}

/**
 * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ ÙˆØªØ£Ø«ÙŠØ±Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø©
 */
function showMessage(element, isSuccess, message) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆÙˆØ¶Ø¹ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    element.className = 'alert ' + (isSuccess ? 'alert-success' : 'alert-warning') + ' my-2 py-2 rounded-3';
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
    const icon = isSuccess 
        ? '<i class="bi bi-check-circle-fill me-2"></i>' 
        : '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
    element.innerHTML = icon + message;
    
    // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±
    element.style.display = 'block';
    element.style.opacity = '0';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ£Ø«ÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ
    setTimeout(() => {
        element.style.transition = 'opacity 0.3s ease';
        element.style.opacity = '1';
    }, 10);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
    const timeout = isSuccess ? 3000 : 5000;
    setTimeout(() => {
        element.style.opacity = '0';
        setTimeout(() => {
            element.style.display = 'none';
        }, 300);
    }, timeout);
}

/**
 * Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆØ£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©
 */
function shareViaWhatsApp(event) {
    console.log("âš™ï¸ Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©");
    
    // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    if (event) event.preventDefault();
    
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø§Ø²Ù…Ø©
    const whatsappButton = document.getElementById('whatsappShareButton');
    const referralField = document.getElementById('referralLink');
    const messageElement = document.getElementById('copyMessage');
    
    if (!whatsappButton || !referralField || !messageElement) {
        alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }
    
    // 2. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    whatsappButton.disabled = true;
    const originalButtonHTML = whatsappButton.innerHTML;
    whatsappButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Ø¬Ø§Ø±Ù Ø§Ù„ÙØªØ­...';
    
    // 3. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
    const referralLink = referralField.value.trim();
    if (!referralLink) {
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
        messageElement.style.display = 'block';
        messageElement.className = 'alert alert-danger my-2 py-2';
        messageElement.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©!';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        whatsappButton.disabled = false;
        whatsappButton.innerHTML = originalButtonHTML;
        return;
    }
    
    // 4. ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    const shareText = `âœ¨ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ù†ØµØ© Ù…Ø³Ø§Ø¨Ù‚Ø§ØªÙŠ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒØ±Ø¨ØªÙˆ Ù…Ø¬Ø§Ù†ÙŠ! ğŸ’°

Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©:
${referralLink}`;
    
    // 5. ØªØ­Ø¯ÙŠØ¯ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨
    const encodedText = encodeURIComponent(shareText);
    // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ØªØºÙ„Ø¨ Ø¹Ù„Ù‰ ØªØ®Ø²ÙŠÙ† Replit Ø§Ù„Ù…Ø¤Ù‚Øª
    const timestamp = new Date().getTime();
    const whatsappUrl = `https://wa.me/?text=${encodedText}&t=${timestamp}`;
    
    // 6. Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø±Ø§Ø¨Ø· Ù…Ø¤Ù‚Øª
        const link = document.createElement('a');
        link.href = whatsappUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
        link.click();
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        messageElement.style.display = 'block';
        messageElement.className = 'alert alert-success my-2 py-2';
        messageElement.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©!';
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
        whatsappButton.disabled = false;
        whatsappButton.className = 'btn btn-outline-success flex-grow-1 d-flex align-items-center justify-content-center gap-1';
        whatsappButton.innerHTML = '<i class="bi bi-check-circle"></i> <span>ØªÙ… Ø§Ù„ÙØªØ­</span>';
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª
        setTimeout(() => {
            document.body.removeChild(link);
        }, 100);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙƒØ§Ø­ØªÙŠØ§Ø· Ø¥Ø¶Ø§ÙÙŠ
        try {
            navigator.clipboard.writeText(shareText);
        } catch (clipErr) {
            console.log("âš ï¸ Ù„Ù… ÙŠØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹");
        }
    } catch (error) {
        console.error("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨:", error);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù†Ø³Ø® Ø§Ù„Ù†Øµ
        fallbackCopyMethod();
    }
    
    // 7. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
    setTimeout(() => {
        if (whatsappButton.className.includes('btn-outline-success')) {
            whatsappButton.className = 'btn btn-success flex-grow-1 d-flex align-items-center justify-content-center gap-1';
            whatsappButton.innerHTML = originalButtonHTML;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
        setTimeout(() => {
            if (messageElement.className.includes('alert-success')) {
                messageElement.style.display = 'none';
            }
        }, 1000);
    }, 3000);
    
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
    function fallbackCopyMethod() {
        console.log("âš ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©");
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù„Ù„Ù†Ø³Ø®
        referralField.select();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(shareText)
                .then(() => {
                    console.log("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­");
                    showCopySuccess();
                })
                .catch(err => {
                    console.error("âš ï¸ ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†Øµ:", err);
                    showManualInstructions();
                });
        } else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… execCommand");
                    showCopySuccess();
                } else {
                    console.warn("âš ï¸ ÙØ´Ù„ Ø£Ù…Ø± Ø§Ù„Ù†Ø³Ø®");
                    showManualInstructions();
                }
            } catch (err) {
                console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø®:", err);
                showManualInstructions();
            }
        }
    }
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø³Ø®
    function showCopySuccess() {
        messageElement.style.display = 'block';
        messageElement.className = 'alert alert-success my-2 py-2';
        messageElement.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i> 
            ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ! <br>
            <small>Ø§Ù„Ø¢Ù† Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©</small>
            <div class="mt-2">
                <a href="https://web.whatsapp.com/" target="_blank" class="btn btn-sm btn-success">
                    <i class="bi bi-whatsapp me-1"></i> ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨
                </a>
            </div>
        `;
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
        whatsappButton.disabled = false;
        whatsappButton.className = 'btn btn-outline-success flex-grow-1 d-flex align-items-center justify-content-center gap-1';
        whatsappButton.innerHTML = '<i class="bi bi-check-circle"></i> <span>ØªÙ… Ø§Ù„Ù†Ø³Ø®</span>';
    }
    
    // Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
    function showManualInstructions() {
        messageElement.style.display = 'block';
        messageElement.className = 'alert alert-warning my-2 py-2';
        messageElement.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ù†Ø³Ø® Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</strong><br>
            <ol class="mt-2 mb-0 small">
                <li>Ø­Ø¯Ø¯ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¹Ù„Ø§Ù‡</li>
                <li>Ø§Ø¶ØºØ· Ctrl+C (Ø£Ùˆ Cmd+C) Ù„Ù†Ø³Ø®Ù‡</li>
                <li>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ</li>
            </ol>
            <div class="mt-2">
                <button onclick="document.getElementById('referralLink').select()" class="btn btn-sm btn-primary me-2">
                    <i class="bi bi-cursor-text"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ
                </button>
                <a href="https://web.whatsapp.com/" target="_blank" class="btn btn-sm btn-success">
                    <i class="bi bi-whatsapp"></i> ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨
                </a>
            </div>
        `;
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
        whatsappButton.disabled = false;
        whatsappButton.className = 'btn btn-warning flex-grow-1 d-flex align-items-center justify-content-center gap-1';
        whatsappButton.innerHTML = '<i class="bi bi-hand-index"></i> <span>Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ</span>';
        
        // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
        whatsappButton.onclick = function() {
            referralField.select();
            messageElement.innerHTML = '<i class="bi bi-info-circle-fill me-2"></i> Ø­Ø¯Ø¯ Ø§Ù„Ù†Øµ ÙˆØ§Ø¶ØºØ· Ctrl+C Ù„Ù†Ø³Ø®Ù‡';
        };
    }
}
</script>
{% endblock %}