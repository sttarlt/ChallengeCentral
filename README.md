# منصة مسابقاتي

منصة "مسابقاتي" هي منصة متكاملة لإدارة المسابقات مصممة للمشرفين والمستخدمين باللغة العربية.

## المكونات الرئيسية

- نظام مصادقة متقدم مع تحكم دقيق بالصلاحيات
- واجهة إدارية آمنة ومرنة
- دعم متعدد اللغات مع التركيز على العربية
- نظام دردشة وتواصل مدمج
- أدوات متقدمة لإدارة المسابقات وتتبع الكربتو
- نظام باقات الكربتو مع خيارات شراء متنوعة

## تشغيل المشروع

1. تأكد من تثبيت Python 3.8 أو أحدث
2. قم بتثبيت المتطلبات:
   ```
   pip install -r requirements.txt
   ```
3. قم بتشغيل الخادم:
   ```
   gunicorn --bind 0.0.0.0:5000 --reuse-port main:app
   ```

## إدارة باقات الكربتو

تم إضافة نظام باقات الكربتو لتمكين المستخدمين من شراء رصيد الكربتو. تتم إدارة هذه الباقات من خلال لوحة تحكم المشرف.

### إضافة أو تعديل باقات الكربتو

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > باقات الكربتو`
3. اضغط على `إضافة باقة جديدة` لإضافة باقة جديدة
4. املأ النموذج بالمعلومات المطلوبة:
   - اسم الباقة: اسم وصفي للباقة (مثال: "الباقة الأساسية")
   - السعر: سعر الباقة بالدولار (مثال: 1.00)
   - الكربتو: عدد الكربتو التي سيحصل عليها المستخدم (مثال: 100)
   - وصف مختصر: وصف اختياري للباقة
   - نشط: حالة الباقة (نشطة أو غير نشطة)
   - ترتيب العرض: رقم لتحديد ترتيب ظهور الباقة (الأرقام الأصغر تظهر أولاً)
5. اضغط على `حفظ الباقة`

### تعديل رابط التواصل للشراء

رابط التواصل هو الرابط الذي سيتم توجيه المستخدمين إليه عند الضغط على زر "تواصل للشراء" في صفحة باقات الكربتو.

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > الإعدادات`
3. قم بتعديل `رابط التواصل للشراء` (يمكن استخدام روابط واتساب، تلغرام، إلخ)
4. اضغط على `حفظ الإعدادات`

#### أمثلة على روابط التواصل المدعومة:

- رابط واتساب: `https://wa.me/رقم_الهاتف`
- رابط تلغرام: `https://t.me/اسم_المستخدم`
- رابط فيسبوك ماسنجر: `https://m.me/اسم_المستخدم_أو_المعرف`
- بريد إلكتروني: `mailto:عنوان_البريد_الإلكتروني`

### إعادة تهيئة الباقات الافتراضية

إذا كنت ترغب في إعادة تهيئة باقات الكربتو إلى القيم الافتراضية، يمكنك تشغيل:

```
python create_default_packages.py
```

هذا السكريبت سيقوم بحذف جميع الباقات الحالية وإنشاء 3 باقات افتراضية:
- باقة أساسية: 1$ = 100 كربتو
- باقة قياسية: 5$ = 600 كربتو
- باقة متميزة: 10$ = 1300 كربتو

## إدارة المسابقات

تتيح المنصة للمشرفين إنشاء وإدارة المسابقات من خلال لوحة التحكم.

### إنشاء مسابقة جديدة

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > المسابقات`
3. اضغط على `إضافة مسابقة جديدة`
4. املأ النموذج بالمعلومات المطلوبة:
   - عنوان المسابقة: عنوان وصفي للمسابقة
   - وصف المسابقة: تفاصيل ومعلومات عن المسابقة وقواعدها
   - الكربتو: عدد نقاط الكربتو التي يمكن كسبها من المسابقة
   - تاريخ البدء: توقيت بدء المسابقة
   - تاريخ الانتهاء: توقيت انتهاء المسابقة
   - نشط: حالة المسابقة (نشطة أو غير نشطة)
5. اضغط على `حفظ المسابقة`

### تعديل مسابقة موجودة

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > المسابقات`
3. ابحث عن المسابقة في القائمة واضغط على زر `تعديل`
4. قم بتعديل المعلومات المطلوبة
5. اضغط على `حفظ المسابقة`

### التعامل مع حالات الخطأ

- في حالة عدم وجود مسابقة بالرقم المطلوب، سيتم عرض رسالة "لم يتم العثور على المسابقة المطلوبة" وإعادة توجيه المستخدم إلى صفحة المسابقات الرئيسية.
- في حالة حدوث أي خطأ آخر، سيتم عرض رسالة خطأ عامة وتسجيل تفاصيل الخطأ في سجل الخادم للمتابعة.

## نظام تحدي الصديق (الإحالة)

تتيح المنصة للمستخدمين دعوة أصدقائهم والحصول على مكافآت كربتو. يتم ذلك من خلال نظام الإحالة المتكامل.

### مزايا النظام

- لكل إحالة ناجحة (عندما يسجل صديق جديد عبر الرابط): 5 كربتو
- لكل 5 إحالات مجمعة: مكافأة إضافية 10 كربتو
- لكل 10 إحالات مجمعة: مكافأة إضافية 20 كربتو
- المستخدم الجديد الذي يسجل عبر رابط الإحالة: مكافأة ترحيبية 2 كربتو
- الحد الأقصى الشهري للمكافآت: 500 كربتو
- الحد الأقصى الإجمالي للمكافآت: 1000 كربتو

### تعديل نظام الإحالة

تتم إدارة إعدادات نظام الإحالة من خلال ملف `config.py` الذي يحتوي على المتغيرات التالية:

```python
# مكافأة لكل إحالة ناجحة (عندما يسجل صديق جديد)
REFERRAL_REWARD_PER_FRIEND = 5

# مكافأة ترحيبية للمستخدم الجديد عند التسجيل عبر رابط إحالة
REFERRAL_WELCOME_BONUS = 2

# المكافآت الإضافية عند الوصول لعدد معين من الإحالات
REFERRAL_MILESTONE_REWARDS = {
    5: 10,   # 5 إحالات = 10 كربتو إضافية
    10: 20,  # 10 إحالات = 20 كربتو إضافية
}

# الحد الأقصى للكربتو من الإحالات شهرياً
REFERRAL_MONTHLY_LIMIT = 500

# الحد الأقصى للكربتو من الإحالات بشكل إجمالي
REFERRAL_TOTAL_LIMIT = 1000
```

لتعديل هذه القيم:
1. قم بفتح ملف `config.py`
2. قم بتعديل القيم حسب الحاجة
3. أعد تشغيل الخادم لتطبيق التغييرات

### تعديل رابط الإحالة

روابط الإحالة تعتمد على كود فريد لكل مستخدم يتم توليده تلقائياً عند التسجيل أو عند زيارة صفحة تحدي الصديق لأول مرة. 

تنسيق رابط الإحالة هو:
```
https://example.com/invite?ref=CODE
```

حيث `CODE` هو كود الإحالة الفريد للمستخدم.

إذا كنت ترغب في تغيير تنسيق الرابط:
1. قم بتعديل الدالة `get_referral_url` في نموذج `User` في ملف `models.py`
2. قم بتعديل المسار `/invite` في ملف `routes.py` ليتناسب مع التنسيق الجديد

## نظام الكربتو الآمن

تم تحسين نظام النقاط في المنصة (الكربتو) ليكون أكثر أماناً وموثوقية بعدة طرق:

### آلية التحقق الشاملة

1. **تحقق من جانب الخادم**: جميع عمليات تعديل النقاط تتم حصراً على الخادم، ولا يمكن التلاعب بها من واجهة المستخدم
2. **تحقق من الجلسة**: التأكد من وجود جلسة نشطة للمستخدم قبل إجراء أي عملية
3. **حماية CSRF**: تأمين النماذج بتوكن CSRF لمنع هجمات الطلبات المزورة
4. **تتبع عنوان IP والمتصفح**: تسجيل معلومات IP و User Agent لكل عملية
5. **فحص الصلاحيات**: ضمان أن المستخدم لديه الصلاحية لإجراء العملية المطلوبة

### نظام سجل العمليات الشامل

تم إنشاء نظام كامل لتسجيل وتتبع كل عمليات الكربتو يتضمن:

1. سجل دقيق لكل عملية تعديل في رصيد الكربتو:
   - المستخدم الذي تم تعديل رصيده
   - مقدار التغيير (إضافة أو خصم)
   - الرصيد بعد العملية
   - نوع العملية (مسابقة، إحالة، جائزة، إلخ)
   - وصف العملية
   - من قام بالتعديل (المستخدم نفسه أو المشرف)
   - معلومات IP والمتصفح
   - التاريخ والوقت

2. لوحة تحكم للمشرفين تتيح:
   - البحث في سجل العمليات حسب معايير متعددة
   - عرض عمليات مستخدم محدد
   - إضافة أو خصم كربتو يدوياً مع تسجيل كامل للعملية

### استخدام نظام سجل العمليات

للوصول إلى سجل عمليات الكربتو:

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > سجل المعاملات`
3. استخدم خيارات البحث المتاحة لتصفية وعرض العمليات المطلوبة

### إضافة أو خصم كربتو للمستخدمين (للمشرفين فقط)

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > سجل المعاملات`
3. اضغط على زر `إضافة/خصم كربتو`
4. أدخل:
   - اسم المستخدم المطلوب تعديل رصيده
   - عدد الكربتو (رقم موجب للإضافة، سالب للخصم)
   - سبب العملية
   - اختر ما إذا كنت ترغب في إشعار المستخدم
5. اضغط على `تعديل الرصيد`

### ملاحظات أمنية

- لا يمكن تعديل سجل العمليات بعد إنشائه
- تظهر معاملات الإستخدام بقيمة سالبة والإضافة بقيمة موجبة للتتبع الأسهل
- يتم منع خصم كربتو أكثر من رصيد المستخدم الحالي
- يتم التحقق من الصلاحيات قبل كل عملية مع تسجيل محاولات الاختراق

## نظام إدارة عمليات شراء الكربتو

تم تطوير نظام متكامل لتسجيل وإدارة عمليات شراء الكربتو، مما يمكّن المشرفين من:

1. تسجيل عمليات شراء جديدة للمستخدمين
2. تتبع المدفوعات وطرق الدفع
3. عرض كامل لسجل عمليات الشراء
4. تحديث رصيد المستخدمين تلقائياً عند تسجيل العمليات

### تسجيل عملية شراء جديدة

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > سجل عمليات الشراء`
3. اضغط على زر `إضافة عملية شراء`
4. املأ نموذج بيانات عملية الشراء:
   - اسم المستخدم: المستخدم الذي قام بالشراء
   - المبلغ المدفوع: المبلغ الذي دفعه المستخدم
   - العملة: عملة الدفع (دولار أمريكي، يورو، ريال سعودي)
   - كمية الكربتو المضافة: عدد الكربتو التي سيحصل عليها المستخدم
   - طريقة الدفع: طريقة استلام المبلغ (تلغرام، تحويل بنكي، PayPal، إلخ)
   - مرجع أو رقم المعاملة: رقم المعاملة أو أي معلومات مرجعية للعملية
   - ملاحظات إضافية: أي معلومات أخرى مهمة عن العملية
5. اضغط على `إضافة عملية الشراء`
6. سيتم تحديث رصيد المستخدم فوراً وإنشاء سجل كامل للعملية

### عرض سجل عمليات الشراء

1. سجل الدخول كمشرف
2. انتقل إلى `لوحة تحكم المشرف > سجل عمليات الشراء`
3. يمكنك استخدام خيارات البحث والتصفية:
   - البحث حسب المستخدم
   - تصفية حسب طريقة الدفع
   - تصفية حسب العملة
   - تحديد نطاق زمني معين
4. لعرض عمليات مستخدم محدد، اضغط على اسم المستخدم في الجدول

### السجل المزدوج وتكامل النظام

- عند تسجيل عملية شراء جديدة، يتم إنشاء سجلين:
  1. سجل في جدول عمليات الشراء (PurchaseRecord)
  2. سجل في جدول معاملات الكربتو (PointsTransaction)

- يتم ربط السجلين ببعضهما البعض لضمان التتبع الكامل للعملية
- يمكن للمشرفين الوصول إلى كلا السجلين من واجهة الإدارة

## مستخدم المشرف الافتراضي

- البريد الإلكتروني: admin@example.com
- كلمة المرور: admin123